#!/bin/bash

mkdir -p "/build"

export CXXFLAGS=-I/opt/mesosphere/include

# TODO(cmaloney): Set alternate log, config paths?
pushd "/pkg/src/nginx"
./configure \
  "--prefix=$PKG_PATH" \
  --with-cc-opt="-I /opt/mesosphere/include" \
  --with-ld-opt="-L /opt/mesosphere/lib -Wl,-rpath=/opt/mesosphere/lib" \
  --with-ipv6 \
  --with-file-aio \
  --with-http_gunzip_module \
  --with-http_gzip_static_module \
  --with-http_spdy_module \
  --without-mail_pop3_module \
  --without-mail_imap_module \
  --without-mail_smtp_module \
  --with-http_ssl_module \
  --with-luajit

make -j8
make install

popd

# Incorporate adminrouter components.
nginx_config_path="$PKG_PATH/nginx/conf"
mkdir -p "$(dirname "$nginx_config_path")"
pushd /pkg/src/adminrouter
cp -r . $nginx_config_path
popd

# Copy  in needed libraries
mkdir -p "$PKG_PATH/lib"
cp /lib/x86_64-linux-gnu/libpcre.so.3 "$PKG_PATH/lib/libpcre.so.3"

systemd_master="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter.service
mkdir -p "$(dirname "$systemd_master")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter.service > "$systemd_master"

systemd_master_reload="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter-reload.service
mkdir -p "$(dirname "$systemd_master_reload")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter-reload.service > "$systemd_master_reload"

systemd_master_timer="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter-reload.timer
mkdir -p "$(dirname "$systemd_master_timer")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter-reload.timer > "$systemd_master_timer"
