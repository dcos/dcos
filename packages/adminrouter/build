#!/bin/bash

mkdir -p "/build"

export CXXFLAGS=-I/opt/mesosphere/include

# TODO(cmaloney): Set alternate log, config paths?
pushd "/pkg/src/nginx"
./configure \
  "--prefix=$PKG_PATH" \
  --with-cc-opt="-I /opt/mesosphere/include" \
  --with-ld-opt="-L /opt/mesosphere/lib -Wl,-rpath=/opt/mesosphere/lib" \
  --with-ipv6 \
  --with-file-aio \
  --with-http_gunzip_module \
  --with-http_gzip_static_module \
  --with-http_spdy_module \
  --without-mail_pop3_module \
  --without-mail_imap_module \
  --without-mail_smtp_module \
  --with-http_ssl_module \
  --with-luajit

make -j8
make install

popd

# Incorporate adminrouter components.
# TODO(jp): Currently, we need to support multiple build variants
# from the same build script which seems unclean. Also, shouldn't
# we just copy the entire AR repo content instead of cherry-picking?
pushd "/pkg/src/adminrouter"

nginx_config_path="$PKG_PATH/nginx/conf"
mkdir -p $nginx_config_path
cp nginx.conf $nginx_config_path/
cp snakeoil.crt $nginx_config_path/
cp snakeoil.key $nginx_config_path/
cp *.lua $nginx_config_path/
if [ -d errorpages ]; then
    cp -r errorpages $nginx_config_path/
fi
# Copy OpenResty Lua modules.
if [ -d resty ]; then
    cp -r resty $nginx_config_path/
fi

popd

# Copy  in needed libraries
mkdir -p "$PKG_PATH/lib"
cp /lib/x86_64-linux-gnu/libpcre.so.3 "$PKG_PATH/lib/libpcre.so.3"

systemd_master="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter.service
mkdir -p "$(dirname "$systemd_master")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter.service > "$systemd_master"

systemd_master_reload="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter-reload.service
mkdir -p "$(dirname "$systemd_master_reload")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter-reload.service > "$systemd_master_reload"

systemd_master_timer="$PKG_PATH"/dcos.target.wants_master/dcos-adminrouter-reload.timer
mkdir -p "$(dirname "$systemd_master_timer")"
envsubst '$PKG_PATH' < /pkg/extra/dcos-adminrouter-reload.timer > "$systemd_master_timer"
