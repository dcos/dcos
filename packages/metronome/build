#!/bin/bash
pushd "/pkg/src/metronome"
rm -rf bin/metronome.bat README.md RUNNING_PID share/ logs/
cp -an * "$PKG_PATH/"
cp -f /pkg/extra/logback.xml "$PKG_PATH/conf/"

metronome_service="$PKG_PATH/dcos.target.wants_master/dcos-metronome.service"
mkdir -p $(dirname "$metronome_service")

cat <<EOF > "$metronome_service"
[Unit]
Description=DC/OS Jobs (Metronome): job orchestration

[Service]
Restart=always
StartLimitInterval=0
RestartSec=15
LimitNOFILE=16384
SyslogIdentifier=metronome
EnvironmentFile=/opt/mesosphere/etc/check_time.env
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=/opt/mesosphere/etc/metronome
EnvironmentFile=-/run/dcos/etc/metronome/service.env
ExecStartPre=/opt/mesosphere/bin/dcos-shell /opt/mesosphere/bin/check-time
ExecStartPre=/opt/mesosphere/bin/dcos-shell /bin/ping -c1 leader.mesos
ExecStartPre=/opt/mesosphere/bin/dcos-shell /opt/mesosphere/bin/bootstrap dcos-metronome
ExecStartPre=/opt/mesosphere/bin/dcos-shell /bin/bash -c 'mkdir -p /run/dcos/etc/metronome'
ExecStartPre=/opt/mesosphere/bin/dcos-shell /bin/bash -c 'echo "METRONOME_LEADER_ELECTION_HOSTNAME=\$(\$MESOS_IP_DISCOVERY_COMMAND)" > /run/dcos/etc/metronome/service.env'
ExecStartPre=/opt/mesosphere/bin/dcos-shell /bin/bash -c 'echo "LIBPROCESS_IP=\$(\$MESOS_IP_DISCOVERY_COMMAND)" >> /run/dcos/etc/metronome/service.env'
ExecStartPre=-/usr/bin/env rm -f /opt/mesosphere/active/metronome/RUNNING_PID
ExecStart=/opt/mesosphere/bin/dcos-shell -u dcos_metronome /opt/mesosphere/bin/metronome
EOF
