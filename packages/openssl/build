#!/bin/bash

mkdir -p "/build"
mkdir -p "$PKG_PATH/etc"

pushd "/pkg/src/openssl-fips"
  export FIPSDIR="$PKG_PATH/etc/fips"
  ./config
  make
  make install
popd


# TODO(cmaloney): Fix the rpath
pushd "/pkg/src/openssl"
./Configure "--prefix=$PKG_PATH" \
  --openssldir="$PKG_PATH/etc/ssl" \
  --with-fipsdir="$PKG_PATH/etc/fips" \
  fips \
  shared \
  linux-x86_64 \
  no-krb5 \
  no-rc4 \
  no-ssl2 \
  no-ssl3 \
  no-comp \
  enable-ec_nistp_64_gcc_128 \
  -Wa,--noexecstack \
  -O2 -DFORTIFY_SOURCE=2

make depend
make
make install

# TODO(cmaloney): This sort of stripping static libraries should be a generic
# mkpanda option to apply to any package.
find "$PKG_PATH/lib/" ! -type d -name "*.a" -delete
find "$PKG_PATH/etc/ssl/man/" -delete
