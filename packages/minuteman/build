#!/bin/bash
set -x

source /opt/mesosphere/environment

pushd /pkg/src/minuteman
make rel
popd

cp -r /pkg/src/minuteman/_build/prod/rel/minuteman ${PKG_PATH}

service=${PKG_PATH}/dcos.target.wants/dcos-minuteman.service
mkdir -p $(dirname $service)
cat <<EOF > $service
[Unit]
Description=Layer 4 Load Balancer: DC/OS Layer 4 Load Balancing Service

[Service]
Restart=always
StartLimitInterval=0
RestartSec=5
WorkingDirectory=${PKG_PATH}/minuteman
EnvironmentFile=/opt/mesosphere/etc/minuteman-erl.env
EnvironmentFile=/opt/mesosphere/etc/check_time.env
EnvironmentFile=/opt/mesosphere/environment
EnvironmentFile=-/opt/mesosphere/etc/minuteman.env
EnvironmentFile=-/run/dcos/etc/minuteman_auth.env
ExecStartPre=/opt/mesosphere/bin/check-time
ExecStartPre=/opt/mesosphere/bin/bootstrap dcos-minuteman
ExecStartPre=/bin/ping -c1 ready.spartan
ExecStartPre=/bin/ping -c1 leader.mesos
ExecStartPre=/usr/bin/env mkdir -p /var/lib/dcos/minuteman/mnesia
ExecStartPre=/usr/bin/env mkdir -p /var/lib/dcos/minuteman/lashup
ExecStartPre=/usr/bin/env ip link add minuteman type dummy
ExecStartPre=/usr/bin/env ip link set minuteman up
ExecStartPre=/usr/bin/env modprobe ip_vs_wlc
ExecStart=${PKG_PATH}/minuteman/bin/minuteman-env foreground
Environment=HOME=/opt/mesosphere
EOF
