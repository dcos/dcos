From c217ed0a3ae273d7e9fa7cb7573da0f8ff537b64 Mon Sep 17 00:00:00 2001
From: Greg Mann <greg@mesosphere.io>
Date: Wed, 1 Aug 2018 07:58:25 -0700
Subject: [PATCH] Added per-framework offer metrics.

Review: https://reviews.apache.org/r/67812/
---
 src/master/master.cpp  | 14 ++++++++++++++
 src/master/metrics.cpp | 20 +++++++++++++++++++-
 src/master/metrics.hpp |  5 +++++
 3 files changed, 38 insertions(+), 1 deletion(-)

diff --git a/src/master/master.cpp b/src/master/master.cpp
index 132eda971..91f907c1f 100644
--- a/src/master/master.cpp
+++ b/src/master/master.cpp
@@ -4029,6 +4029,8 @@ void Master::accept(
     // Validate the offers.
     error = validation::offer::validate(accept.offer_ids(), this, framework);
 
+    size_t offersAccepted = 0;
+
     // Compute offered resources and remove the offers. If the
     // validation failed, return resources to the allocator.
     foreach (const OfferID& offerId, accept.offer_ids()) {
@@ -4046,6 +4048,8 @@ void Master::accept(
           slaveId = offer->slave_id();
           allocationInfo = offer->allocation_info();
           offeredResources += offer->resources();
+
+          offersAccepted++;
         }
 
         removeOffer(offer);
@@ -4057,6 +4061,8 @@ void Master::accept(
       LOG(WARNING) << "Ignoring accept of offer " << offerId
                    << " since it is no longer valid";
     }
+
+    framework->metrics.offers_accepted += offersAccepted;
   }
 
   // If invalid, send TASK_DROPPED for the launch attempts. If the
@@ -5570,6 +5576,8 @@ void Master::decline(
 
   ++metrics->messages_decline_offers;
 
+  size_t offersDeclined = 0;
+
   //  Return resources to the allocator.
   foreach (const OfferID& offerId, decline.offer_ids()) {
     Offer* offer = getOffer(offerId);
@@ -5581,6 +5589,8 @@ void Master::decline(
           decline.filters());
 
       removeOffer(offer);
+
+      offersDeclined++;
       continue;
     }
 
@@ -5589,6 +5599,8 @@ void Master::decline(
     LOG(WARNING) << "Ignoring decline of offer " << offerId
                  << " since it is no longer valid";
   }
+
+  framework->metrics.offers_declined += offersDeclined;
 }
 
 
@@ -8915,6 +8927,7 @@ void Master::offer(
 
   LOG(INFO) << "Sending offers " << offerIds << " to framework " << *framework;
 
+  framework->metrics.offers_sent += message.offers().size();
   framework->send(message);
 }
 
@@ -10839,6 +10852,7 @@ void Master::removeOffer(Offer* offer, bool rescind)
   if (rescind) {
     RescindResourceOfferMessage message;
     message.mutable_offer_id()->MergeFrom(offer->id());
+    framework->metrics.offers_rescinded++;
     framework->send(message);
   }
 
diff --git a/src/master/metrics.cpp b/src/master/metrics.cpp
index bd424ba80..d62514c0e 100644
--- a/src/master/metrics.cpp
+++ b/src/master/metrics.cpp
@@ -521,10 +521,23 @@ FrameworkMetrics::FrameworkMetrics(const FrameworkInfo& _frameworkInfo)
     calls(
         getFrameworkMetricPrefix(frameworkInfo) + "calls"),
     events(
-        getFrameworkMetricPrefix(frameworkInfo) + "events")
+        getFrameworkMetricPrefix(frameworkInfo) + "events"),
+    offers_sent(
+        getFrameworkMetricPrefix(frameworkInfo) + "offers/sent"),
+    offers_accepted(
+        getFrameworkMetricPrefix(frameworkInfo) + "offers/accepted"),
+    offers_declined(
+        getFrameworkMetricPrefix(frameworkInfo) + "offers/declined"),
+    offers_rescinded(
+        getFrameworkMetricPrefix(frameworkInfo) + "offers/rescinded")
 {
   process::metrics::add(subscribed);
 
+  process::metrics::add(offers_sent);
+  process::metrics::add(offers_accepted);
+  process::metrics::add(offers_declined);
+  process::metrics::add(offers_rescinded);
+
   // Add metrics for scheduler calls.
   process::metrics::add(calls);
   for (int index = 0;
@@ -586,6 +599,11 @@ FrameworkMetrics::~FrameworkMetrics()
   foreachvalue (const Counter& counter, event_types) {
     process::metrics::remove(counter);
   }
+
+  process::metrics::remove(offers_sent);
+  process::metrics::remove(offers_accepted);
+  process::metrics::remove(offers_declined);
+  process::metrics::remove(offers_rescinded);
 }
 
 
diff --git a/src/master/metrics.hpp b/src/master/metrics.hpp
index fac4440da..b6fe20fb5 100644
--- a/src/master/metrics.hpp
+++ b/src/master/metrics.hpp
@@ -230,6 +230,11 @@ struct FrameworkMetrics
 
   process::metrics::Counter events;
   hashmap<scheduler::Event::Type, process::metrics::Counter> event_types;
+
+  process::metrics::Counter offers_sent;
+  process::metrics::Counter offers_accepted;
+  process::metrics::Counter offers_declined;
+  process::metrics::Counter offers_rescinded;
 };
 
 
-- 
2.17.0

