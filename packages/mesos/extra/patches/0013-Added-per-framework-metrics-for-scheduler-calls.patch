From 8ff7622b2eebb14e48256533011073199610fcda Mon Sep 17 00:00:00 2001
From: Greg Mann <greg@mesosphere.io>
Date: Wed, 1 Aug 2018 07:58:14 -0700
Subject: [PATCH] Added per-framework metrics for scheduler calls.

Review: https://reviews.apache.org/r/67776/
---
 src/master/http.cpp    |  2 ++
 src/master/master.cpp  |  6 ++++++
 src/master/metrics.cpp | 43 +++++++++++++++++++++++++++++++++++++++++-
 src/master/metrics.hpp |  7 +++++++
 4 files changed, 57 insertions(+), 1 deletion(-)

diff --git a/src/master/http.cpp b/src/master/http.cpp
index 1f9aac44f..f4cd2dc68 100644
--- a/src/master/http.cpp
+++ b/src/master/http.cpp
@@ -1056,6 +1056,8 @@ Future<Response> Master::Http::scheduler(
     return BadRequest("Framework cannot be found");
   }
 
+  framework->metrics.incrementCall(call.type());
+
   // TODO(greggomann): Move this implicit scheduler authorization
   // into the authorizer. See MESOS-7399.
   if (principal.isSome() && principal != framework->info.principal()) {
diff --git a/src/master/master.cpp b/src/master/master.cpp
index e31fd5532..132eda971 100644
--- a/src/master/master.cpp
+++ b/src/master/master.cpp
@@ -2487,6 +2487,8 @@ void Master::receive(
     return;
   }
 
+  framework->metrics.incrementCall(call.type());
+
   // This is possible when master --> framework link is broken (i.e., one
   // way network partition) and the framework is not aware of it. There
   // is no way for driver based frameworks to detect this in the absence
@@ -2808,6 +2810,8 @@ void Master::_subscribe(
 
     addFramework(framework, suppressedRoles);
 
+    framework->metrics.incrementCall(scheduler::Call::SUBSCRIBE);
+
     FrameworkRegisteredMessage message;
     message.mutable_framework_id()->MergeFrom(framework->id());
     message.mutable_master_info()->MergeFrom(info_);
@@ -2841,6 +2845,8 @@ void Master::_subscribe(
 
   CHECK_NOTNULL(framework);
 
+  framework->metrics.incrementCall(scheduler::Call::SUBSCRIBE);
+
   if (!framework->recovered()) {
     // The framework has previously been registered with this master;
     // it may or may not currently be connected.
diff --git a/src/master/metrics.cpp b/src/master/metrics.cpp
index af687f749..5a32aad6a 100644
--- a/src/master/metrics.cpp
+++ b/src/master/metrics.cpp
@@ -16,6 +16,8 @@
 
 #include <string>
 
+#include <mesos/scheduler/scheduler.hpp>
+
 #include <process/http.hpp>
 
 #include <process/metrics/counter.hpp>
@@ -515,15 +517,54 @@ void Metrics::incrementTasksStates(
 FrameworkMetrics::FrameworkMetrics(const FrameworkInfo& _frameworkInfo)
   : frameworkInfo(_frameworkInfo),
     subscribed(
-        getFrameworkMetricPrefix(frameworkInfo) + "subscribed")
+        getFrameworkMetricPrefix(frameworkInfo) + "subscribed"),
+    calls(
+        getFrameworkMetricPrefix(frameworkInfo) + "calls")
 {
   process::metrics::add(subscribed);
+
+  // Add metrics for scheduler calls.
+  process::metrics::add(calls);
+  for (int index = 0;
+       index < scheduler::Call::Type_descriptor()->value_count();
+       index++) {
+    const google::protobuf::EnumValueDescriptor* descriptor =
+      scheduler::Call::Type_descriptor()->value(index);
+
+    const scheduler::Call::Type type =
+      static_cast<scheduler::Call::Type>(descriptor->number());
+
+    if (type == scheduler::Call::UNKNOWN) {
+      continue;
+    }
+
+    Counter counter = Counter(
+        getFrameworkMetricPrefix(frameworkInfo) + "calls/" +
+        strings::lower(descriptor->name()));
+
+    call_types.put(type, counter);
+    process::metrics::add(counter);
+  }
 }
 
 
 FrameworkMetrics::~FrameworkMetrics()
 {
   process::metrics::remove(subscribed);
+
+  process::metrics::remove(calls);
+  foreachvalue (const Counter& counter, call_types) {
+    process::metrics::remove(counter);
+  }
+}
+
+
+void FrameworkMetrics::incrementCall(const scheduler::Call::Type& callType)
+{
+  CHECK(call_types.contains(callType));
+
+  call_types.get(callType).get()++;
+  calls++;
 }
 
 
diff --git a/src/master/metrics.hpp b/src/master/metrics.hpp
index d3f093f9d..7a7b3a316 100644
--- a/src/master/metrics.hpp
+++ b/src/master/metrics.hpp
@@ -20,6 +20,8 @@
 #include <string>
 #include <vector>
 
+#include <mesos/scheduler/scheduler.hpp>
+
 #include <process/metrics/counter.hpp>
 #include <process/metrics/pull_gauge.hpp>
 #include <process/metrics/push_gauge.hpp>
@@ -215,9 +217,14 @@ struct FrameworkMetrics
 
   ~FrameworkMetrics();
 
+  void incrementCall(const scheduler::Call::Type& callType);
+
   const FrameworkInfo frameworkInfo;
 
   process::metrics::PushGauge subscribed;
+
+  process::metrics::Counter calls;
+  hashmap<scheduler::Call::Type, process::metrics::Counter> call_types;
 };
 
 
-- 
2.17.0

