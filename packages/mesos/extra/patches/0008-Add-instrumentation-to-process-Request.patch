From c71983dc07cdef92a6efca9b18e69bf9623ac14c Mon Sep 17 00:00:00 2001
From: Benno Evers <bevers@mesosphere.com>
Date: Wed, 23 May 2018 14:44:47 +0200
Subject: [PATCH] Add instrumentation to process::Request.

---
 3rdparty/libprocess/include/process/http.hpp | 18 +++++++++++++++++-
 3rdparty/libprocess/src/http.cpp             |  1 +
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/3rdparty/libprocess/include/process/http.hpp b/3rdparty/libprocess/include/process/http.hpp
index ba1b086a1..5df1de49b 100644
--- a/3rdparty/libprocess/include/process/http.hpp
+++ b/3rdparty/libprocess/include/process/http.hpp
@@ -17,6 +17,7 @@
 #include <stdint.h>
 
 #include <atomic>
+#include <ctime>
 #include <initializer_list>
 #include <iosfwd>
 #include <memory>
@@ -518,7 +519,12 @@ public:
 struct Request
 {
   Request()
-    : keepAlive(false), type(BODY) {}
+    : keepAlive(false)
+    , type(BODY)
+    , requestNumber(counter++)
+  {
+    ::clock_gettime(CLOCK_MONOTONIC, &received);
+  }
 
   std::string method;
 
@@ -563,6 +569,14 @@ struct Request
   std::string body;
   Option<Pipe::Reader> reader;
 
+  // Temporary benchmarking support.
+  struct timespec received;
+  mutable struct timespec authorizing;
+  mutable struct timespec crunching;
+  mutable struct timespec serializing;
+  mutable struct timespec finished;
+  uint64_t requestNumber;
+
   /**
    * Returns whether the encoding is considered acceptable in the
    * response. See RFC 2616 section 14.3 for details.
@@ -586,6 +600,8 @@ struct Request
       const std::string& mediaType) const;
 
 private:
+  static std::atomic<uint64_t> counter;
+
   bool _acceptsMediaType(
       Option<std::string> name,
       const std::string& mediaType) const;
diff --git a/3rdparty/libprocess/src/http.cpp b/3rdparty/libprocess/src/http.cpp
index a4d71fb6c..91d3b5492 100644
--- a/3rdparty/libprocess/src/http.cpp
+++ b/3rdparty/libprocess/src/http.cpp
@@ -82,6 +82,7 @@ using process::network::internal::SocketImpl;
 namespace process {
 namespace http {
 
+std::atomic<uint64_t> Request::counter;
 
 hashmap<uint16_t, string>* statuses = new hashmap<uint16_t, string> {
   {100, "100 Continue"},
-- 
2.14.1

