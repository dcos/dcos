From 5b346926e9aa49e2d87a07ccbc32ab7e3893119b Mon Sep 17 00:00:00 2001
From: Joseph Wu <josephwu@apache.org>
Date: Thu, 10 Nov 2016 11:29:19 -0800
Subject: [PATCH 03/24] Revert "Fixed the broken metrics information of master
 in WebUI."

This reverts commit b2fc58883e2cd0ca144fd1b0e10cad4235a50223.

In DC/OS, redirection to the leading master is handled by the
Adminrouter component.
---
 src/webui/master/static/js/controllers.js | 24 +++++++----------------
 1 file changed, 7 insertions(+), 17 deletions(-)

diff --git a/src/webui/master/static/js/controllers.js b/src/webui/master/static/js/controllers.js
index 6e0a40f93..8d9b5f49d 100644
--- a/src/webui/master/static/js/controllers.js
+++ b/src/webui/master/static/js/controllers.js
@@ -349,7 +349,8 @@
   }
 
   // Update the outermost scope with the metrics/snapshot endpoint.
-  function updateMetrics($scope, $timeout, metrics) {
+  function updateMetrics($scope, $timeout, data) {
+    var metrics = JSON.parse(data);
     $scope.staging_tasks = metrics['master/tasks_staging'];
     $scope.starting_tasks = metrics['master/tasks_starting'];
     $scope.running_tasks = metrics['master/tasks_running'];
@@ -446,18 +447,6 @@
       if (!matched) $scope.navbarActiveTab = null;
     });
 
-    var leadingMasterURL = function(path) {
-      // Use current location as address in case we could not find the
-      // leading master.
-      var address = location.hostname + ':' + location.port;
-      if ($scope.state && $scope.state.leader_info) {
-          address = $scope.state.leader_info.hostname + ':' +
-                    $scope.state.leader_info.port;
-      }
-
-      return '//' + address + path;
-    }
-
     var popupErrorModal = function() {
       if ($scope.delay >= 128000) {
         $scope.delay = 2000;
@@ -517,7 +506,7 @@
       // the leading master automatically. This would cause a CORS error if we
       // use XMLHttpRequest here. To avoid the CORS error, we use JSONP as a
       // workaround. Please refer to MESOS-5911 for further details.
-      $http.jsonp(leadingMasterURL('/master/state?jsonp=JSON_CALLBACK'))
+      $http.jsonp('master/state?jsonp=JSON_CALLBACK')
         .success(function(response) {
           if (updateState($scope, $timeout, response)) {
             $scope.delay = updateInterval(_.size($scope.agents));
@@ -532,9 +521,10 @@
     };
 
     var pollMetrics = function() {
-      $http.jsonp(leadingMasterURL('/metrics/snapshot?jsonp=JSON_CALLBACK'))
-        .success(function(response) {
-          if (updateMetrics($scope, $timeout, response)) {
+      $http.get('metrics/snapshot',
+                {transformResponse: function(data) { return data; }})
+        .success(function(data) {
+          if (updateMetrics($scope, $timeout, data)) {
             $scope.delay = updateInterval(_.size($scope.agents));
             $timeout(pollMetrics, $scope.delay);
           }
-- 
2.21.0

