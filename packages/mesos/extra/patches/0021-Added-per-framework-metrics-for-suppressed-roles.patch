From aff32bda9922f88a6bed2ae201d2731ceecd5e65 Mon Sep 17 00:00:00 2001
From: Greg Mann <greg@mesosphere.io>
Date: Wed, 1 Aug 2018 07:59:04 -0700
Subject: [PATCH 21/24] Added per-framework metrics for suppressed roles.

Review: https://reviews.apache.org/r/66870/
---
 src/master/allocator/mesos/hierarchical.cpp |  7 +++
 src/master/allocator/mesos/metrics.cpp      | 66 ++++++++++++++++++++-
 src/master/allocator/mesos/metrics.hpp      | 12 ++++
 3 files changed, 83 insertions(+), 2 deletions(-)

diff --git a/src/master/allocator/mesos/hierarchical.cpp b/src/master/allocator/mesos/hierarchical.cpp
index 91c27f619..982377c5b 100644
--- a/src/master/allocator/mesos/hierarchical.cpp
+++ b/src/master/allocator/mesos/hierarchical.cpp
@@ -319,8 +319,10 @@ void HierarchicalAllocatorProcess::addFramework(
 
     if (suppressedRoles.count(role)) {
       frameworkSorters.at(role)->deactivate(frameworkId.value());
+      framework.metrics->suppressRole(role);
     } else {
       frameworkSorters.at(role)->activate(frameworkId.value());
+      framework.metrics->reviveRole(role);
     }
   }
 
@@ -463,6 +465,8 @@ void HierarchicalAllocatorProcess::updateFramework(
   const set<string> oldSuppressedRoles = framework.suppressedRoles;
 
   foreach (const string& role, newRoles - oldRoles) {
+    framework.metrics->addSubscribedRole(role);
+
     // NOTE: It's possible that we're already tracking this framework
     // under the role because a framework can unsubscribe from a role
     // while it still has resources allocated to the role.
@@ -486,6 +490,7 @@ void HierarchicalAllocatorProcess::updateFramework(
       framework.offerFilters.erase(role);
     }
 
+    framework.metrics->removeSubscribedRole(role);
     framework.suppressedRoles.erase(role);
   }
 
@@ -1282,6 +1287,7 @@ void HierarchicalAllocatorProcess::suppressRoles(
 
     frameworkSorters.at(role)->deactivate(frameworkId.value());
     framework.suppressedRoles.insert(role);
+    framework.metrics->suppressRole(role);
   }
 
   // TODO(bmahler): This logs roles that were already suppressed,
@@ -1322,6 +1328,7 @@ void HierarchicalAllocatorProcess::unsuppressRoles(
 
     frameworkSorters.at(role)->activate(frameworkId.value());
     framework.suppressedRoles.erase(role);
+    framework.metrics->reviveRole(role);
   }
 
   // TODO(bmahler): This logs roles that were already unsuppressed,
diff --git a/src/master/allocator/mesos/metrics.cpp b/src/master/allocator/mesos/metrics.cpp
index 7a4b153db..0b5534715 100644
--- a/src/master/allocator/mesos/metrics.cpp
+++ b/src/master/allocator/mesos/metrics.cpp
@@ -21,15 +21,21 @@
 #include <mesos/quota/quota.hpp>
 
 #include <process/metrics/pull_gauge.hpp>
+#include <process/metrics/push_gauge.hpp>
 #include <process/metrics/metrics.hpp>
 
 #include <stout/hashmap.hpp>
 
+#include "common/protobuf_utils.hpp"
+
+#include "master/metrics.hpp"
+
 #include "master/allocator/mesos/hierarchical.hpp"
 
 using std::string;
 
 using process::metrics::PullGauge;
+using process::metrics::PushGauge;
 
 namespace mesos {
 namespace internal {
@@ -203,10 +209,66 @@ void Metrics::removeRole(const string& role)
 
 
 FrameworkMetrics::FrameworkMetrics(const FrameworkInfo& _frameworkInfo)
-  : frameworkInfo(_frameworkInfo) {}
+  : frameworkInfo(_frameworkInfo)
+{
+  // TODO(greggomann): Calling `getRoles` below copies the roles from the
+  // framework info, which could become expensive if the number of roles grows
+  // large. Consider optimizing this.
+  foreach (
+      const string& role,
+      protobuf::framework::getRoles(frameworkInfo)) {
+    addSubscribedRole(role);
+  }
+}
+
+
+FrameworkMetrics::~FrameworkMetrics()
+{
+  foreach (const string& role, suppressed.keys()) {
+    removeSubscribedRole(role);
+  }
+
+  CHECK(suppressed.empty());
+}
+
+
+void FrameworkMetrics::reviveRole(const string& role)
+{
+  auto iter = suppressed.find(role);
+  CHECK(iter != suppressed.end());
+  iter->second = 0;
+}
 
 
-FrameworkMetrics::~FrameworkMetrics() {}
+void FrameworkMetrics::suppressRole(const string& role)
+{
+  auto iter = suppressed.find(role);
+  CHECK(iter != suppressed.end());
+  iter->second = 1;
+}
+
+
+void FrameworkMetrics::addSubscribedRole(const string& role)
+{
+  auto result = suppressed.emplace(
+      role,
+      PushGauge(
+          getFrameworkMetricPrefix(frameworkInfo) + "roles/" +
+          role + "/suppressed"));
+
+  CHECK(result.second);
+  process::metrics::add(result.first->second);
+}
+
+
+void FrameworkMetrics::removeSubscribedRole(const string& role)
+{
+  auto iter = suppressed.find(role);
+
+  CHECK(iter != suppressed.end());
+  process::metrics::remove(iter->second);
+  suppressed.erase(iter);
+}
 
 } // namespace internal {
 } // namespace allocator {
diff --git a/src/master/allocator/mesos/metrics.hpp b/src/master/allocator/mesos/metrics.hpp
index daac93f7e..34cc16b3a 100644
--- a/src/master/allocator/mesos/metrics.hpp
+++ b/src/master/allocator/mesos/metrics.hpp
@@ -24,6 +24,7 @@
 
 #include <process/metrics/counter.hpp>
 #include <process/metrics/pull_gauge.hpp>
+#include <process/metrics/push_gauge.hpp>
 #include <process/metrics/timer.hpp>
 
 #include <process/pid.hpp>
@@ -97,7 +98,18 @@ struct FrameworkMetrics
 
   ~FrameworkMetrics();
 
+  void reviveRole(const std::string& role);
+  void suppressRole(const std::string& role);
+
+  // Since frameworks can update their list of roles,
+  // these methods add/remove per-role metrics.
+  void addSubscribedRole(const std::string& role);
+  void removeSubscribedRole(const std::string& role);
+
   const FrameworkInfo frameworkInfo;
+
+  // Suppresion state metric (boolean 0 or 1) for each role.
+  hashmap<std::string, process::metrics::PushGauge> suppressed;
 };
 
 } // namespace internal {
-- 
2.21.0

